<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Main Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="./classes/menus.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        .page-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .content-frame {
            flex-grow: 1;
            width: 100%;
            border: none;
        }

        .dropdown-menu .dropdown-item:hover {
             background-color: #0d6efd;  /* Bootstrap primary blue */
            color: white;
        }

        .navbar .dropdown-menu .dropdown-toggle:hover {
           background-color: #0d6efd;
            color: white;
        }

      /*  .dropdown-submenu .dropdown-menu { display: none; }
        .dropdown-submenu.show > .dropdown-menu { display: block; }*/


.dropdown-submenu { position: relative; }
.dropdown-submenu > .dropdown-menu { 
  top: 0; left: 100%; margin-left: .1rem;
  display: none;
  position: absolute;
}
.dropdown-submenu > .dropdown-menu.show { display: block; }


    </style>
</head>

<body>

    <div class="page-container">

        <!-- NAVBAR -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
            <a class="navbar-brand" href="#">MyApp</a>

            <!-- Mobile toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>


            <div class="collapse navbar-collapse" id="navbarContent">

                 <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="menuContainer">
                    <!-- Menus will be rendered here dynamically -->
                </ul> 

                <!-- LEFT MENUS -->
                <!-- <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            Masters
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="loadPage('suppliers.html')">Suppliers</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadPage('items.html')">Items</a></li>
                
                        </ul>
                    </li>
                
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            Transactions
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="loadPage('orders.html')">Orders</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadPage('invoices.html')">Invoices</a></li>
                            <li class="dropdown-submenu dropend">
                                <a class="dropdown-item dropdown-toggle" href="#" role="button">
                                    Purchases
                                </a>
                            
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="loadPage('pos.html')">POs</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="loadPage('deliveries.html')">Deliveries</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadPage('reports.html')">Reports</a>
                    </li>
                </ul>-->

                <!-- RIGHT SIDE (SEARCH + USER MENU) -->
                <div class="d-flex align-items-center gap-3">

                    <!-- SEARCH -->
                    <form class="d-flex" onsubmit="search(event)">
                        <input class="form-control form-control-sm me-2" type="search" placeholder="Search">
                        <button class="btn btn-outline-light btn-sm" type="submit">
                            Search
                        </button>
                    </form>



                    <!-- USER MENU -->
                    <div class="dropdown">
                        <a href="#" class="text-white fs-5" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" onclick="openSettings()">Settings</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
        </nav>


         <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button  name = "pgTitle" id ="pgTitle"  class="nav-link active text-primary fw-semibold"
                    data-bs-toggle="tab"
                    data-bs-target="#tab_1"
                    type="button">
                
            </button>
        </li>

       <!-- <li class="nav-item" role="presentation">
            <button class="nav-link"
                    data-bs-toggle="tab"
                    data-bs-target="#tab_"
                    type="button">
                Second Tab
            </button>
        </li>  -->
    </ul>
        <!-- IFRAME -->
        <div id ="tab-content" class="tab-content">

        <!-- TAB 1 -->
        <div class="tab-pane fade show active"
             id="tab_1">

            <iframe id="contentFrame" name="contentFrame"
                    src="welcome.html"
                    style="width:100%; height:90vh; border:none;">
            </iframe>

        </div>

       <!-- TAB 2 
        <div class="tab-pane fade"
             id="tab_2">

            <div class="p-3">
                Second tab content here
            </div>

        </div> --> 

    </div>
    

        <div class="modal fade" id="htmlDialog" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body p-0">
                        <iframe id="dialogFrame" style="width:100%; height:70vh; border:none;">
                        </iframe>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        let htmlDialogInstance = null;

    function openNewIframeTab(pageUrl, title) {
         console.log(title);
         
         const homeTabs = window.parent.document.getElementsByName("pgTitle");
         console.log(homeTabs.length);
        const tabId = "tab_" +homeTabs.length+1;  // unique id
        console.log(homeTabs.length);
        const tabsContainer = document.getElementById("mainTabs");
        const contentContainer = document.getElementById("tab-content");

        // ----------------------
        // Create Tab Button
        // ----------------------
        const li = document.createElement("li");
        li.className = "nav-item";
        li.role = "presentation";

        const button = document.createElement("button");
        button.className = "nav-link active text-primary  fw-semibold";
        button.name = "pgTitle"
        button.dataset.bsToggle = "tab";
        button.dataset.bsTarget = "#" + tabId;
        button.type = "button";
        button.role = "tab";
        button.innerHTML = `
            ${title}
            <i class="bi bi-x ms-2" style="cursor:pointer;"></i>
        `;

        li.appendChild(button);

        // ----------------------
        // Create Tab Content
        // ----------------------
        const tabPane = document.createElement("div");
        tabPane.className = "tab-pane fade show active";
        tabPane.id = tabId;
        tabPane.role = "tabpanel";

        tabPane.innerHTML = `
            <iframe name="contentFrame"
                    src="welcome.html"
                    style="width:100%; height:90vh; border:none;">
            </iframe>
        `;

        // ----------------------
        // Deactivate existing tabs
        // ----------------------
        document.querySelectorAll("#mainTabs .nav-link")
            .forEach(t => t.classList.remove("active"));

        document.querySelectorAll("#tab-content .tab-pane")
            .forEach(p => p.classList.remove("show", "active"));

        // ----------------------
        // Append new tab
        // ----------------------
        tabsContainer.appendChild(li);
        contentContainer.appendChild(tabPane);


        console.log(document.getElementsByName("contentFrame"));
        document.getElementsByName("contentFrame")[homeTabs.length-1].src = pageUrl;
        document.getElementBy


    }

        function loadPage(event, page,title) {
            
            
            if (event.shiftKey) {
                console.log("Shift was pressed");
                event.preventDefault();
                openNewIframeTab(page,title);
            return;
        }else {

            document.getElementsByName("contentFrame")[0].src = page;
        }

        }

        function search(event) {
            event.preventDefault();
            console.log("Search triggered");
            // TODO: implement search
        }

        function openSettings() {
            // document.getElementById("contentFrame").src = './general/userprofile.html';
            // TODO: open settings page
            /*document.querySelector('#htmlDialog .modal-title').textContent = 'User Profile';
            document.getElementById('dialogFrame').src = './general/userprofile.html';

            const modal = new bootstrap.Modal(document.getElementById('htmlDialog'));
            modal.show();*/


            const modalEl = document.getElementById('htmlDialog');

            modalEl.querySelector('.modal-title').textContent = 'User Profile';
            modalEl.querySelector('#dialogFrame').src = './general/userprofile.html';;

            htmlDialogInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            htmlDialogInstance.show();
        }


        function closeHtmlDialog() {
            if (htmlDialogInstance) {
                htmlDialogInstance.hide();
            }
        }

        function logout() {
            console.log("Logout clicked");
            localStorage.removeItem("jwtToken");
            window.location.href = "index.html";
        }


    </script>

    <script>
        // Group 1

        axios.interceptors.request.use(config => {
            const token = localStorage.getItem("jwtToken");
            console.log(token);
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        });

        loadMenusFromBackend();

            document.addEventListener("DOMContentLoaded", () => {
            document.addEventListener("click", function (e) {
            const toggle = e.target.closest(".dropdown-submenu > .dropdown-toggle");
            if (!toggle) return;

            e.preventDefault();

            // stop Bootstrap from seeing this click and closing the parent dropdown
            e.stopPropagation();
            e.stopImmediatePropagation();

            // toggle submenu
            const submenu = toggle.nextElementSibling; // <ul class="dropdown-menu">
            const parentMenu = toggle.closest(".dropdown-menu"); 
            submenu.classList.toggle("show");
             parentMenu.querySelectorAll(".dropdown-submenu > .dropdown-menu.show")
            .forEach(m => { if (m !== submenu) m.classList.remove("show"); });
            }, true);

            document.querySelectorAll(".dropdown").forEach(dd => {
                dd.addEventListener("hidden.bs.dropdown", () => {
                dd.querySelectorAll(".dropdown-menu.show").forEach(m => m.classList.remove("show"));
                console.log('248;');
                });
            });

         
        });

        document.addEventListener("click", function (e) {
  // If user clicked an actual submenu item (not a toggle), close open submenus
        const item = e.target.closest(".dropdown-submenu .dropdown-menu .dropdown-item");
        const isToggle = e.target.closest(".dropdown-submenu > .dropdown-toggle");

    if (item && !isToggle) {
        document.querySelectorAll(".dropdown-submenu .dropdown-menu.show")
        .forEach(m => m.classList.remove("show"));
    }
        }, true); // capture phase (important)

    </script>
</body>

</html>