<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Main Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="./classes/menus.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        .page-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .content-frame {
            flex-grow: 1;
            width: 100%;
            border: none;
        }

      /*  .dropdown-submenu .dropdown-menu { display: none; }
        .dropdown-submenu.show > .dropdown-menu { display: block; }*/


.dropdown-submenu { position: relative; }
.dropdown-submenu > .dropdown-menu { 
  top: 0; left: 100%; margin-left: .1rem;
  display: none;
  position: absolute;
}
.dropdown-submenu > .dropdown-menu.show { display: block; }


    </style>
</head>

<body>

    <div class="page-container">

        <!-- NAVBAR -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
            <a class="navbar-brand" href="#">MyApp</a>

            <!-- Mobile toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>


            <div class="collapse navbar-collapse" id="navbarContent">

                 <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="menuContainer">
                    <!-- Menus will be rendered here dynamically -->
                </ul> 

                <!-- LEFT MENUS -->
                <!-- <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            Masters
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="loadPage('suppliers.html')">Suppliers</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadPage('items.html')">Items</a></li>
                
                        </ul>
                    </li>
                
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            Transactions
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="loadPage('orders.html')">Orders</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadPage('invoices.html')">Invoices</a></li>
                            <li class="dropdown-submenu dropend">
                                <a class="dropdown-item dropdown-toggle" href="#" role="button">
                                    Purchases
                                </a>
                            
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="loadPage('pos.html')">POs</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="loadPage('deliveries.html')">Deliveries</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadPage('reports.html')">Reports</a>
                    </li>
                </ul>-->

                <!-- RIGHT SIDE (SEARCH + USER MENU) -->
                <div class="d-flex align-items-center gap-3">

                    <!-- SEARCH -->
                    <form class="d-flex" onsubmit="search(event)">
                        <input class="form-control form-control-sm me-2" type="search" placeholder="Search">
                        <button class="btn btn-outline-light btn-sm" type="submit">
                            Search
                        </button>
                    </form>



                    <!-- USER MENU -->
                    <div class="dropdown">
                        <a href="#" class="text-white fs-5" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" onclick="openSettings()">Settings</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
        </nav>

        <!-- IFRAME -->
        <iframe id="contentFrame" class="content-frame" src="welcome.html">
        </iframe>

        <div class="modal fade" id="htmlDialog" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body p-0">
                        <iframe id="dialogFrame" style="width:100%; height:70vh; border:none;">
                        </iframe>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        let htmlDialogInstance = null;
        function loadPage(page) {
            document.getElementById("contentFrame").src = page;
        }

        function search(event) {
            event.preventDefault();
            console.log("Search triggered");
            // TODO: implement search
        }

        function openSettings() {
            // document.getElementById("contentFrame").src = './general/userprofile.html';
            // TODO: open settings page
            /*document.querySelector('#htmlDialog .modal-title').textContent = 'User Profile';
            document.getElementById('dialogFrame').src = './general/userprofile.html';

            const modal = new bootstrap.Modal(document.getElementById('htmlDialog'));
            modal.show();*/


            const modalEl = document.getElementById('htmlDialog');

            modalEl.querySelector('.modal-title').textContent = 'User Profile';
            modalEl.querySelector('#dialogFrame').src = './general/userprofile.html';;

            htmlDialogInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            htmlDialogInstance.show();
        }


        function closeHtmlDialog() {
            if (htmlDialogInstance) {
                htmlDialogInstance.hide();
            }
        }

        function logout() {
            console.log("Logout clicked");
            localStorage.removeItem("jwtToken");
            window.location.href = "index.html";
        }


    </script>

    <script>
        // Group 1

        axios.interceptors.request.use(config => {
            const token = localStorage.getItem("jwtToken");
            console.log(token);
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        });


        document.addEventListener("DOMContentLoaded", () => {
            document.addEventListener("click", function (e) {
            const toggle = e.target.closest(".dropdown-submenu > .dropdown-toggle");
            if (!toggle) return;

            e.preventDefault();

            // stop Bootstrap from seeing this click and closing the parent dropdown
            e.stopPropagation();
            e.stopImmediatePropagation();

            // toggle submenu
            const submenu = toggle.nextElementSibling; // <ul class="dropdown-menu">
            submenu.classList.toggle("show");
            }, true);

            document.querySelectorAll(".dropdown").forEach(dd => {
                dd.addEventListener("hidden.bs.dropdown", () => {
                dd.querySelectorAll(".dropdown-menu.show").forEach(m => m.classList.remove("show"));
                console.log('248;');
                });
            });

         loadMenusFromBackend();
        });
    </script>
</body>

</html>